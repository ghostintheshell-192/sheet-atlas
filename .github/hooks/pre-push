#!/bin/bash
# Git Pre-Push Hook - Test Runner
# Executes unit tests before pushing to remote
# Created: 2025-10-18
# Location: /data/repos/.git-hooks/pre-push

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo -e "${BLUE}  Pre-Push Tests${NC}"
echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
echo ""

# Check if solution file exists
SOLUTION_FILE=$(find . -maxdepth 1 -name "*.sln" | head -n 1)

if [ -z "$SOLUTION_FILE" ]; then
    echo -e "${YELLOW}ℹ No solution file found, skipping tests${NC}"
    exit 0
fi

echo -e "${GREEN}[Pre-Push Test Check]${NC} Running unit tests..."
echo ""

# Run unit tests only (fast)
# --filter excludes integration tests (convention: namespace contains ".Integration")
# --no-build uses existing build (faster)
# --verbosity quiet reduces output noise
dotnet test "$SOLUTION_FILE" \
    --filter "FullyQualifiedName!~Integration" \
    --no-build \
    --configuration Release \
    --verbosity quiet \
    --nologo

TEST_EXIT_CODE=$?

echo ""

if [ $TEST_EXIT_CODE -ne 0 ]; then
    echo -e "${RED}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo -e "${RED}✗ Tests FAILED - Push blocked${NC}"
    echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo ""
    echo -e "${YELLOW}Fix the failing tests before pushing.${NC}"
    echo ""
    echo -e "${YELLOW}To bypass this check (not recommended):${NC}"
    echo -e "  git push --no-verify"
    echo ""
    exit 1
else
    echo -e "${GREEN}✓ Unit tests passed${NC}"
    echo -e "${BLUE}━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━${NC}"
    echo ""
    echo -e "${GREEN}✓ Pre-push checks PASSED - Proceeding with push${NC}"
    echo ""
    exit 0
fi
