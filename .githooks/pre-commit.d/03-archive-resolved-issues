#!/bin/bash
# Archive Resolved Tech Debt Issues
# Automatically moves resolved/closed/rejected issues from tech-debt/ to archive/completed/
# Part of pre-commit hook chain

GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

echo -e "${GREEN}[Archive Resolved Issues]${NC} Checking for resolved tech debt issues..."

# Find the repository root
REPO_ROOT=$(git rev-parse --show-toplevel)

# Check if .personal/ exists (not all repos will have it)
if [ ! -d "$REPO_ROOT/.personal/active/tech-debt" ]; then
    echo -e "${GREEN}✓ No tech-debt directory${NC} - skipping archive check"
    exit 0
fi

TECH_DEBT_DIR="$REPO_ROOT/.personal/active/tech-debt"
ARCHIVE_DIR="$REPO_ROOT/.personal/archive/completed"
CURRENT_DATE=$(date +%Y-%m-%d)

# Get list of staged files in tech-debt/ (only check files being committed)
STAGED_TECH_DEBT=$(git diff --cached --name-only --diff-filter=AM | grep "^\.personal/active/tech-debt/.*\.md$" || true)

if [ -z "$STAGED_TECH_DEBT" ]; then
    echo -e "${GREEN}✓ No tech-debt issues staged${NC}"
    exit 0
fi

MOVED_COUNT=0
MOVED_FILES=""

# Process each staged tech-debt file
while IFS= read -r file; do
    FULL_PATH="$REPO_ROOT/$file"
    FILENAME=$(basename "$file")

    # Skip template file
    if [ "$FILENAME" = "_TEMPLATE.md" ] || [ "$FILENAME" = "README.md" ]; then
        continue
    fi

    # Extract status from YAML frontmatter
    # Look for "status: resolved", "status: closed", or "status: rejected"
    STATUS=$(grep -m 1 "^status:" "$FULL_PATH" 2>/dev/null | sed 's/status: *//' | tr -d ' \r\n')

    if [ "$STATUS" = "resolved" ] || [ "$STATUS" = "closed" ] || [ "$STATUS" = "rejected" ]; then
        # Check if filename already has date prefix (YYYY-MM-DD_)
        if [[ ! "$FILENAME" =~ ^[0-9]{4}-[0-9]{2}-[0-9]{2}_ ]]; then
            # Add date prefix
            NEW_FILENAME="${CURRENT_DATE}_${FILENAME}"
        else
            # Already has date, keep as is
            NEW_FILENAME="$FILENAME"
        fi

        NEW_PATH="$ARCHIVE_DIR/$NEW_FILENAME"

        # Create archive directory if needed
        mkdir -p "$ARCHIVE_DIR"

        # Move the file
        mv "$FULL_PATH" "$NEW_PATH"

        # Update git staging: remove old path, add new path
        git reset HEAD "$file" 2>/dev/null || true
        git add "$NEW_PATH"

        MOVED_COUNT=$((MOVED_COUNT + 1))
        MOVED_FILES="${MOVED_FILES}\n  - ${FILENAME} → archive/completed/${NEW_FILENAME}"

        echo -e "${BLUE}  ↪ Archived:${NC} $FILENAME (status: $STATUS)"
    fi
done <<< "$STAGED_TECH_DEBT"

if [ $MOVED_COUNT -gt 0 ]; then
    echo -e "${GREEN}✓ Archived $MOVED_COUNT resolved issue(s)${NC}"
    echo -e "${YELLOW}Note:${NC} Files moved to .personal/archive/completed/"
else
    echo -e "${GREEN}✓ No resolved issues to archive${NC}"
fi

exit 0
