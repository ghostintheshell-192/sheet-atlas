<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="using:SheetAtlas.UI.Avalonia.ViewModels"
             mc:Ignorable="d" d:DesignWidth="256" d:DesignHeight="600"
             x:Class="SheetAtlas.UI.Avalonia.Views.FilesSidebarView"
             x:DataType="vm:MainWindowViewModel">

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <!-- Header with action buttons -->
        <Grid Grid.Row="0" Margin="8,8,8,8">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>

            <TextBlock Grid.Column="0" Text="Loaded Files" FontWeight="SemiBold"
                      FontSize="14"
                      Foreground="{DynamicResource PrimaryText}"/>

            <Button Grid.Column="1" Content="Deselect"
                    Padding="8,4"
                    FontSize="11"
                    Margin="0,0,4,0"
                    ToolTip.Tip="Clear file selection"
                    Click="OnClearSelectionClick"
                    IsVisible="{Binding SelectedFile, Converter={x:Static ObjectConverters.IsNotNull}}"/>

            <Button Grid.Column="2" Content="Unload"
                    Classes="DangerButton"
                    Padding="8,4"
                    FontSize="11"
                    ToolTip.Tip="Remove selected file from list"
                    Click="OnUnloadFileClick"
                    IsVisible="{Binding SelectedFile, Converter={x:Static ObjectConverters.IsNotNull}}"/>
        </Grid>

        <ListBox Grid.Row="1"
                 x:Name="FilesListBox"
                 ItemsSource="{Binding LoadedFiles}"
                 SelectedItem="{Binding SelectedFile}"
                 SelectionMode="Multiple"
                 SelectionChanged="OnFilesSelectionChanged"
                 Margin="4"
                 Padding="0,0,0,-8"
                 Background="{DynamicResource CardBackground}"
                 BorderBrush="{DynamicResource BorderColor}"
                 BorderThickness="1"
                 CornerRadius="4">
            <ListBox.ItemTemplate>
                <DataTemplate>
                    <StackPanel Orientation="Vertical" Margin="0">
                        <Grid Tapped="OnFileItemTapped" Background="Transparent">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>

                            <!-- Status icon -->
                            <Panel Grid.Column="0" Margin="0,0,8,0" VerticalAlignment="Center">
                                <TextBlock Text="⬢" FontSize="16" Foreground="{DynamicResource ErrorColor}" IsVisible="{Binding HasErrors}"/>
                                <TextBlock Text="△" FontSize="16" Foreground="{DynamicResource AccentOrange}">
                                    <TextBlock.IsVisible>
                                        <MultiBinding Converter="{x:Static BoolConverters.And}">
                                            <Binding Path="HasWarnings"/>
                                            <Binding Path="HasErrors" Converter="{x:Static BoolConverters.Not}"/>
                                        </MultiBinding>
                                    </TextBlock.IsVisible>
                                </TextBlock>
                                <TextBlock Text="○" FontSize="16" Foreground="{DynamicResource SuccessColor}">
                                    <TextBlock.IsVisible>
                                        <MultiBinding Converter="{x:Static BoolConverters.And}">
                                            <Binding Path="HasErrors" Converter="{x:Static BoolConverters.Not}"/>
                                            <Binding Path="HasWarnings" Converter="{x:Static BoolConverters.Not}"/>
                                        </MultiBinding>
                                    </TextBlock.IsVisible>
                                </TextBlock>
                            </Panel>

                            <!-- File name and path -->
                            <StackPanel Grid.Column="1" Orientation="Vertical">
                                <TextBlock Text="{Binding FileName}"
                                          FontWeight="Medium"
                                          Foreground="{DynamicResource PrimaryText}"/>
                                <TextBlock Text="{Binding FilePath}"
                                          FontSize="10"
                                          Foreground="{DynamicResource SecondaryText}"
                                          TextTrimming="CharacterEllipsis"/>
                            </StackPanel>

                            <!-- Error count badge -->
                            <Border Grid.Column="2"
                                   Background="{DynamicResource ErrorBackground}"
                                   CornerRadius="10"
                                   Padding="6,2"
                                   Margin="4,0,4,0"
                                   VerticalAlignment="Center">
                                <Border.IsVisible>
                                    <MultiBinding Converter="{x:Static BoolConverters.Or}">
                                        <Binding Path="HasErrors"/>
                                        <Binding Path="HasWarnings"/>
                                    </MultiBinding>
                                </Border.IsVisible>
                                <TextBlock Text="{Binding Errors.Count, StringFormat='{}{0}'}"
                                          FontSize="10"
                                          FontWeight="SemiBold"
                                          Foreground="{DynamicResource ErrorColor}"/>
                            </Border>
                        </Grid>
                    </StackPanel>
                </DataTemplate>
            </ListBox.ItemTemplate>
        </ListBox>
    </Grid>
</UserControl>
