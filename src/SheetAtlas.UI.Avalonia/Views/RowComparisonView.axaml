<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:SheetAtlas.UI.Avalonia.ViewModels"
             xmlns:entities="using:SheetAtlas.Core.Domain.Entities"
             xmlns:converters="using:SheetAtlas.UI.Avalonia.Converters"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             mc:Ignorable="d" d:DesignWidth="800" d:DesignHeight="600"
             x:Class="SheetAtlas.UI.Avalonia.Views.RowComparisonView"
             x:DataType="vm:RowComparisonViewModel">

    <Design.DataContext>
        <vm:RowComparisonViewModel/>
    </Design.DataContext>

    <UserControl.Resources>
        <converters:ComparisonTypeToBackgroundConverter x:Key="ComparisonTypeToBackgroundConverter"/>
    </UserControl.Resources>

    <!-- Comparison Table Content (header is managed by CollapsibleSection in MainWindow) -->
    <Border BorderBrush="{DynamicResource SearchQueryBorder}"
            BorderThickness="2"
            CornerRadius="4"
            Margin="0,8,0,0"
            IsVisible="{Binding HasRows}">
        <ScrollViewer HorizontalScrollBarVisibility="Auto" VerticalScrollBarVisibility="Auto">
            <Grid Grid.IsSharedSizeScope="True" Margin="0,0,16,16">
            <Grid.ColumnDefinitions>
                <!-- Row Info Column -->
                <ColumnDefinition Width="250" MinWidth="200"/>
                <!-- Dynamic columns for data -->
                <ColumnDefinition Width="Auto"/>
            </Grid.ColumnDefinitions>
            <Grid.RowDefinitions>
                <!-- Column Headers -->
                <RowDefinition Height="Auto"/>
                <!-- Data -->
                <RowDefinition Height="*"/>
            </Grid.RowDefinitions>

            <!-- Row Info Header -->
            <Border Grid.Column="0" Grid.Row="0" Background="{DynamicResource ComparisonHeaderBackground}"
                    BorderBrush="{DynamicResource BorderColor}"
                    BorderThickness="0,0,1,1" Padding="12">
                <TextBlock Text="Source" FontWeight="SemiBold" Foreground="{DynamicResource SearchQueryText}" VerticalAlignment="Center"/>
            </Border>

            <!-- Column Headers -->
            <ItemsControl Grid.Column="1" Grid.Row="0" ItemsSource="{Binding Columns}">
                <ItemsControl.ItemsPanel>
                    <ItemsPanelTemplate>
                        <StackPanel Orientation="Horizontal"/>
                    </ItemsPanelTemplate>
                </ItemsControl.ItemsPanel>
                <ItemsControl.ItemTemplate>
                    <DataTemplate DataType="vm:RowComparisonColumnViewModel">
                        <Border Background="{DynamicResource ComparisonHeaderBackground}"
                                BorderBrush="{DynamicResource BorderColor}"
                                BorderThickness="0,0,1,1"
                                Padding="12"
                                MinWidth="140">
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto" SharedSizeGroup="{Binding ColumnIndex, StringFormat='Col{0}'}"/>
                                </Grid.ColumnDefinitions>
                                <TextBlock Text="{Binding Header}"
                                          FontWeight="SemiBold"
                                          Foreground="{DynamicResource SearchQueryText}"
                                          TextTrimming="CharacterEllipsis"
                                          VerticalAlignment="Center"
                                          MaxWidth="220"/>
                            </Grid>
                        </Border>
                    </DataTemplate>
                </ItemsControl.ItemTemplate>
            </ItemsControl>

            <!-- Row Data -->
            <ItemsControl Grid.Column="0" Grid.Row="1" ItemsSource="{Binding Comparison.Rows}">
                <ItemsControl.ItemTemplate>
                    <DataTemplate DataType="entities:ExcelRow">
                        <Border Background="{DynamicResource SecondaryBackground}"
                                BorderBrush="{DynamicResource BorderColor}"
                                BorderThickness="0,0,1,1"
                                MinHeight="36" Padding="12">
                            <TextBlock Text="{Binding DisplayName}"
                                      VerticalAlignment="Center"
                                      TextTrimming="CharacterEllipsis"
                                      FontSize="12"
                                      FontWeight="Medium"
                                      Foreground="{DynamicResource SecondaryText}"/>
                        </Border>
                    </DataTemplate>
                </ItemsControl.ItemTemplate>
            </ItemsControl>

            <!-- Cell Data Grid -->
            <ItemsControl Grid.Column="1" Grid.Row="1" ItemsSource="{Binding Columns}">
                    <ItemsControl.ItemsPanel>
                        <ItemsPanelTemplate>
                            <StackPanel Orientation="Horizontal"/>
                        </ItemsPanelTemplate>
                    </ItemsControl.ItemsPanel>
                    <ItemsControl.ItemTemplate>
                        <DataTemplate DataType="vm:RowComparisonColumnViewModel">
                            <StackPanel>
                                <ItemsControl ItemsSource="{Binding Cells}">
                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate DataType="vm:RowComparisonCellViewModel">
                                            <Border Background="{Binding ComparisonResult, Converter={StaticResource ComparisonTypeToBackgroundConverter}}"
                                                    BorderBrush="{DynamicResource BorderColor}"
                                                    BorderThickness="0,0,1,1"
                                                    MinHeight="36" Padding="12"
                                                    MinWidth="140">
                                                <Grid>
                                                    <Grid.ColumnDefinitions>
                                                        <ColumnDefinition Width="Auto" SharedSizeGroup="{Binding ColumnIndex, StringFormat='Col{0}'}"/>
                                                    </Grid.ColumnDefinitions>
                                                    <TextBlock Text="{Binding Value}"
                                                              VerticalAlignment="Center"
                                                              TextTrimming="CharacterEllipsis"
                                                              FontSize="12"
                                                              Foreground="{DynamicResource PrimaryText}"
                                                              ToolTip.Tip="{Binding Value}"
                                                              MaxWidth="220"/>
                                                </Grid>
                                            </Border>
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                </ItemsControl>
                            </StackPanel>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
            </ItemsControl>
            </Grid>
        </ScrollViewer>
    </Border>
</UserControl>
