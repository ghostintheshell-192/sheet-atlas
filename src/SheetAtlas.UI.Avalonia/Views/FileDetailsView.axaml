<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:vm="using:SheetAtlas.UI.Avalonia.ViewModels"
             xmlns:controls="using:SheetAtlas.UI.Avalonia.Controls"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             mc:Ignorable="d" d:DesignWidth="800" d:DesignHeight="600"
             x:Class="SheetAtlas.UI.Avalonia.Views.FileDetailsView"
             x:DataType="vm:FileDetailsViewModel">

    <Design.DataContext>
        <vm:FileDetailsViewModel/>
    </Design.DataContext>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>  <!-- BASIC INFORMATION -->
            <RowDefinition Height="Auto"/>  <!-- TEMPLATE MANAGEMENT -->
            <RowDefinition Height="*"/>     <!-- NOTIFICATIONS AND ERRORS -->
        </Grid.RowDefinitions>

        <!-- BASIC INFORMATION Section -->
        <controls:CollapsibleSection Grid.Row="0"
                                     IsExpanded="True"
                                     IsVisible="{Binding HasSelectedFile}">
            <controls:CollapsibleSection.Header>
                <Grid ColumnDefinitions="*,Auto">
                    <TextBlock Grid.Column="0"
                               Text="BASIC INFORMATION"
                               FontWeight="Bold"
                               FontSize="12"
                               Foreground="{DynamicResource SearchQueryText}"/>
                    <!-- Toolbar Buttons (Right) -->
                    <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="8">
                        <Button Content="Export Excel"
                                Classes="ModernButton"
                                Command="{Binding ExportExcelCommand}"
                                ToolTip.Tip="Export normalized data to Excel file"
                                FontSize="11"/>
                        <Button Content="Export CSV"
                                Classes="SecondaryButton"
                                Command="{Binding ExportCsvCommand}"
                                ToolTip.Tip="Export normalized data to CSV file"
                                FontSize="11"/>
                        <Button Content="Retry"
                                Classes="SecondaryButton"
                                Command="{Binding RetryCommand}"
                                FontSize="11"/>
                        <Button Content="Clear"
                                Classes="SecondaryButton"
                                Command="{Binding ClearCommand}"
                                FontSize="11"/>
                    </StackPanel>
                </Grid>
            </controls:CollapsibleSection.Header>
            <controls:CollapsibleSection.Content>
                <Border Background="{DynamicResource CardBackground}"
                        Padding="12">
                    <!-- Information Grid -->
                    <Grid ColumnDefinitions="100,*" RowDefinitions="Auto,Auto">
                        <!-- File Path -->
                        <TextBlock Grid.Row="0" Grid.Column="0"
                                  Text="FILE PATH"
                                  FontWeight="SemiBold"
                                  FontSize="11"
                                  Foreground="{DynamicResource SecondaryText}"
                                  Margin="0,0,8,6"/>
                        <TextBlock Grid.Row="0" Grid.Column="1"
                                  Text="{Binding FilePath}"
                                  FontSize="11"
                                  Foreground="{DynamicResource PrimaryText}"
                                  TextWrapping="Wrap"
                                  Margin="0,0,0,6"/>

                        <!-- File Size -->
                        <TextBlock Grid.Row="1" Grid.Column="0"
                                  Text="FILE SIZE"
                                  FontWeight="SemiBold"
                                  FontSize="11"
                                  Foreground="{DynamicResource SecondaryText}"
                                  Margin="0,0,8,0"/>
                        <TextBlock Grid.Row="1" Grid.Column="1"
                                  Text="{Binding FileSize}"
                                  FontSize="11"
                                  Foreground="{DynamicResource PrimaryText}"/>
                    </Grid>
                </Border>
            </controls:CollapsibleSection.Content>
        </controls:CollapsibleSection>

        <!-- TEMPLATE MANAGEMENT Section -->
        <controls:CollapsibleSection Grid.Row="1"
                                     IsExpanded="False"
                                     IsVisible="{Binding HasSelectedFile}">
            <controls:CollapsibleSection.Header>
                <Grid ColumnDefinitions="*,Auto">
                    <TextBlock Grid.Column="0"
                               Text="TEMPLATE MANAGEMENT"
                               FontWeight="Bold"
                               FontSize="12"
                               Foreground="{DynamicResource SearchQueryText}"/>
                    <!-- Status indicator -->
                    <StackPanel Grid.Column="1" Orientation="Horizontal" Spacing="8"
                                IsVisible="{Binding HasValidationResult}">
                        <TextBlock Text="{Binding ValidationStatusIcon}"
                                   FontSize="14"
                                   VerticalAlignment="Center"/>
                        <TextBlock Text="{Binding ValidationStatusText}"
                                   FontSize="11"
                                   VerticalAlignment="Center"
                                   Foreground="{DynamicResource SearchQueryText}"/>
                    </StackPanel>
                </Grid>
            </controls:CollapsibleSection.Header>
            <controls:CollapsibleSection.Content>
                <Border Background="{DynamicResource CardBackground}"
                        Padding="12">
                    <StackPanel Spacing="16">

                        <!-- Section 1: Create Template from Current File -->
                        <StackPanel Spacing="6">
                            <TextBlock Text="Create Template"
                                       FontWeight="SemiBold"
                                       FontSize="11"
                                       Foreground="{DynamicResource SecondaryText}"/>
                            <Button Content="Save Current File as Template"
                                    Classes="SecondaryButton"
                                    Command="{Binding SaveAsTemplateCommand}"
                                    HorizontalAlignment="Left"/>
                        </StackPanel>

                        <!-- Separator -->
                        <Border Height="1" Background="{DynamicResource SubtleBorder}"/>

                        <!-- Section 2: Validate Against Template -->
                        <StackPanel Spacing="6">
                            <TextBlock Text="Validate Against Template"
                                       FontWeight="SemiBold"
                                       FontSize="11"
                                       Foreground="{DynamicResource SecondaryText}"/>

                            <Grid ColumnDefinitions="*,Auto,Auto" RowDefinitions="Auto">
                                <!-- Template Dropdown -->
                                <ComboBox Grid.Column="0"
                                          ItemsSource="{Binding AvailableTemplates}"
                                          SelectedItem="{Binding SelectedTemplate}"
                                          PlaceholderText="Select a template..."
                                          HorizontalAlignment="Stretch"
                                          Margin="0,0,8,0">
                                    <ComboBox.ItemTemplate>
                                        <DataTemplate>
                                            <TextBlock Text="{Binding Name}"/>
                                        </DataTemplate>
                                    </ComboBox.ItemTemplate>
                                </ComboBox>

                                <!-- Load Template Button -->
                                <Button Grid.Column="1"
                                        Content="Load..."
                                        Classes="SecondaryButton"
                                        Command="{Binding LoadTemplateCommand}"
                                        ToolTip.Tip="Load template from file"
                                        Margin="0,0,8,0"/>

                                <!-- Validate Button -->
                                <Button Grid.Column="2"
                                        Content="Validate"
                                        Classes="ModernButton"
                                        Command="{Binding ValidateCommand}"
                                        IsEnabled="{Binding CanValidate}"/>
                            </Grid>
                        </StackPanel>

                        <!-- Validation Progress -->
                        <ProgressBar IsVisible="{Binding IsValidating}"
                                     IsIndeterminate="True"
                                     Height="4"/>

                        <!-- Validation Results (shown after validation) -->
                        <Border IsVisible="{Binding HasValidationResult}"
                                Background="{DynamicResource MainBackground}"
                                CornerRadius="4"
                                Padding="12">
                            <StackPanel Spacing="8">
                                <!-- Summary -->
                                <Grid ColumnDefinitions="Auto,*">
                                    <Border Grid.Column="0"
                                            Background="{Binding ValidationResultBackground}"
                                            CornerRadius="4"
                                            Padding="8,4"
                                            Margin="0,0,12,0">
                                        <TextBlock Text="{Binding ValidationResultStatus}"
                                                   FontWeight="SemiBold"
                                                   Foreground="White"/>
                                    </Border>
                                    <TextBlock Grid.Column="1"
                                               Text="{Binding ValidationSummary}"
                                               VerticalAlignment="Center"
                                               TextWrapping="Wrap"/>
                                </Grid>

                                <!-- Issues List (if any) -->
                                <ItemsControl ItemsSource="{Binding ValidationIssues}"
                                              IsVisible="{Binding HasValidationIssues}">
                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate x:DataType="vm:ValidationIssueViewModel">
                                            <Border Padding="8,4"
                                                    BorderThickness="0,0,0,1"
                                                    BorderBrush="{DynamicResource SubtleBorder}"
                                                    Background="Transparent">
                                                <Border.Styles>
                                                    <Style Selector="Border:pointerover">
                                                        <Setter Property="Background" Value="{DynamicResource HoverBackground}"/>
                                                    </Style>
                                                </Border.Styles>
                                                <Grid ColumnDefinitions="Auto,Auto,*">
                                                    <!-- Severity Icon -->
                                                    <TextBlock Grid.Column="0"
                                                               Text="{Binding SeverityIcon}"
                                                               Margin="0,0,8,0"
                                                               VerticalAlignment="Center"
                                                               FontSize="12"/>
                                                    <!-- Location -->
                                                    <TextBlock Grid.Column="1"
                                                               Text="{Binding Location}"
                                                               FontWeight="SemiBold"
                                                               Foreground="{DynamicResource AccentOrange}"
                                                               FontSize="11"
                                                               Margin="0,0,8,0"
                                                               VerticalAlignment="Center"/>
                                                    <!-- Message -->
                                                    <TextBlock Grid.Column="2"
                                                               Text="{Binding Message}"
                                                               TextWrapping="Wrap"
                                                               VerticalAlignment="Center"
                                                               FontSize="12"
                                                               Foreground="{DynamicResource PrimaryText}"/>
                                                </Grid>
                                            </Border>
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                </ItemsControl>

                            </StackPanel>
                        </Border>
                    </StackPanel>
                </Border>
            </controls:CollapsibleSection.Content>
        </controls:CollapsibleSection>

        <!-- NOTIFICATIONS AND ERRORS Section -->
        <controls:CollapsibleSection Grid.Row="2"
                                     IsExpanded="True"
                                     IsVisible="{Binding HasSelectedFile}">
            <controls:CollapsibleSection.Header>
                <Grid ColumnDefinitions="*,Auto">
                    <TextBlock Grid.Column="0"
                               Text="NOTIFICATIONS AND ERRORS"
                               FontWeight="Bold"
                               FontSize="12"
                               Foreground="{DynamicResource SearchQueryText}"/>
                    <!-- Error count indicator -->
                    <TextBlock Grid.Column="1"
                               Text="{Binding ErrorLogs.Count, StringFormat='({0})'}"
                               FontSize="11"
                               Foreground="{DynamicResource SearchQueryText}"
                               IsVisible="{Binding HasErrorLogs}"/>
                </Grid>
            </controls:CollapsibleSection.Header>
            <controls:CollapsibleSection.Content>
                <Border Background="{DynamicResource CardBackground}">
                    <Grid RowDefinitions="Auto,*">
                        <!-- Table Header -->
                        <Border Grid.Row="0"
                                Background="{DynamicResource SecondaryBackground}"
                                BorderBrush="{DynamicResource SubtleBorder}"
                                BorderThickness="0,0,0,1"
                                Padding="8,6">
                            <Grid ColumnDefinitions="160,100,*">
                                <TextBlock Grid.Column="0"
                                          Text="TIMESTAMP"
                                          FontWeight="Bold"
                                          FontSize="11"
                                          Foreground="{DynamicResource SecondaryText}"/>
                                <TextBlock Grid.Column="1"
                                          Text="LOG LEVEL"
                                          FontWeight="Bold"
                                          FontSize="11"
                                          Foreground="{DynamicResource SecondaryText}"/>
                                <TextBlock Grid.Column="2"
                                          Text="MESSAGE"
                                          FontWeight="Bold"
                                          FontSize="11"
                                          Foreground="{DynamicResource SecondaryText}"/>
                            </Grid>
                        </Border>

                        <!-- Table Content -->
                        <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto">
                            <StackPanel>
                                <!-- Loading Indicator -->
                                <ProgressBar IsVisible="{Binding IsLoadingHistory}"
                                            IsIndeterminate="True"
                                            Margin="12"/>

                                <!-- Error Log Rows -->
                                <ItemsControl ItemsSource="{Binding ErrorLogs}"
                                             IsVisible="{Binding !IsLoadingHistory}">
                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate x:DataType="vm:ErrorLogRowViewModel">
                                            <Border BorderBrush="{DynamicResource SubtleBorder}"
                                                   BorderThickness="0,0,0,1"
                                                   Padding="8,4"
                                                   Background="Transparent">
                                                <Border.Styles>
                                                    <Style Selector="Border:pointerover">
                                                        <Setter Property="Background" Value="{DynamicResource HoverBackground}"/>
                                                    </Style>
                                                </Border.Styles>

                                                <Grid ColumnDefinitions="160,100,*">
                                                    <!-- Timestamp -->
                                                    <TextBlock Grid.Column="0"
                                                              Text="{Binding TimestampFormatted}"
                                                              FontSize="11"
                                                              VerticalAlignment="Center"
                                                              Foreground="{DynamicResource SecondaryText}"/>

                                                    <!-- Log Level -->
                                                    <TextBlock Grid.Column="1"
                                                              Text="{Binding LogLevelText}"
                                                              FontSize="11"
                                                              FontWeight="SemiBold"
                                                              VerticalAlignment="Center"
                                                              Foreground="{Binding LogLevelColor}"/>

                                                    <!-- Message -->
                                                    <TextBlock Grid.Column="2"
                                                              Text="{Binding Message}"
                                                              FontSize="12"
                                                              TextWrapping="Wrap"
                                                              VerticalAlignment="Center"
                                                              Foreground="{DynamicResource PrimaryText}"/>
                                                </Grid>
                                            </Border>
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                </ItemsControl>

                                <!-- Empty State -->
                                <TextBlock Text="No error logs available. File load attempts will appear here."
                                          FontStyle="Italic"
                                          Foreground="{DynamicResource SecondaryText}"
                                          HorizontalAlignment="Center"
                                          Margin="0,40,0,40"
                                          IsVisible="{Binding !HasErrorLogs}"/>
                            </StackPanel>
                        </ScrollViewer>
                    </Grid>
                </Border>
            </controls:CollapsibleSection.Content>
        </controls:CollapsibleSection>

        <!-- Empty State (no file selected) -->
        <TextBlock Text="Select a file from the list to view details"
                  Grid.RowSpan="3"
                  FontStyle="Italic"
                  Foreground="{DynamicResource SecondaryText}"
                  HorizontalAlignment="Center"
                  VerticalAlignment="Center"
                  Margin="0,40,0,0"
                  IsVisible="{Binding SelectedFile, Converter={x:Static ObjectConverters.IsNull}}"/>
    </Grid>
</UserControl>
