<Window xmlns="https://github.com/avaloniaui"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:vm="using:SheetAtlas.UI.Avalonia.ViewModels"
        xmlns:views="using:SheetAtlas.UI.Avalonia.Views"
        xmlns:controls="using:SheetAtlas.UI.Avalonia.Controls"
        xmlns:converters="using:SheetAtlas.UI.Avalonia.Converters"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        mc:Ignorable="d" d:DesignWidth="1200" d:DesignHeight="800"
        x:Class="SheetAtlas.UI.Avalonia.Views.MainWindow"
        x:DataType="vm:MainWindowViewModel"
        Title="Excel Cross Reference Viewer"
        MinWidth="800" MinHeight="600"
        Background="{DynamicResource MainBackground}">

    <Window.Resources>
        <converters:CollectionNotEmptyConverter x:Key="CollectionNotEmptyConverter"/>
        <converters:BoolToSidebarWidthConverter x:Key="BoolToSidebarWidthConverter"/>
        <converters:BoolToTextConverter x:Key="BoolToTextConverter"/>
    </Window.Resources>

    <Design.DataContext>
        <vm:MainWindowViewModel/>
    </Design.DataContext>

    <Grid Margin="10">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Professional Menu Bar -->
        <Menu Grid.Row="0"
              Background="{DynamicResource SecondaryBackground}"
              BorderBrush="{DynamicResource BorderColor}"
              BorderThickness="0,0,0,1"
              Padding="8,0"
              Margin="0,0,0,8"
              Foreground="{DynamicResource PrimaryText}">

            <!-- File Menu -->
            <MenuItem Header="_File">
                <MenuItem Header="ðŸ“ _Load Files"
                         Command="{Binding LoadFileCommand}"/>
                <MenuItem Header="ðŸ—‘ï¸ _Unload All Files"
                         Command="{Binding UnloadAllFilesCommand}"
                         IsEnabled="{Binding HasLoadedFiles}"/>
                <Separator/>
                <MenuItem Header="Recent Files" IsEnabled="False"/>
            </MenuItem>

            <!-- View Menu -->
            <MenuItem Header="_View">
                <MenuItem Header="Show _File Details"
                          Command="{Binding ShowFileDetailsTabCommand}"
                          IsEnabled="{Binding HasLoadedFiles}"/>
                <MenuItem Header="Show _Search"
                          Command="{Binding ShowSearchTabCommand}"/>
                <MenuItem Header="Show _Comparison"
                          Command="{Binding ShowComparisonTabCommand}"/>
                <Separator/>
                <MenuItem Header="{Binding IsStatusBarVisible, Converter={StaticResource BoolToTextConverter}, ConverterParameter='Hide Status Bar|Show Status Bar'}"
                          Command="{Binding ToggleStatusBarCommand}"/>
            </MenuItem>

            <!-- Tools Menu -->
            <MenuItem Header="_Tools">
                <MenuItem Header="_Export Results" IsEnabled="False"/>
                <Separator/>
                <MenuItem Header="_Settings" IsEnabled="False"/>
            </MenuItem>

            <!-- Help Menu -->
            <MenuItem Header="_Help">
                <MenuItem Header="ðŸ“‹ View Error _Log"
                         Command="{Binding ViewErrorLogCommand}"
                         InputGesture="Ctrl+L"/>
                <Separator/>
                <MenuItem Header="_About SheetAtlas"
                         Command="{Binding ShowAboutCommand}"/>
                <MenuItem Header="_Documentation"
                         Command="{Binding ShowDocumentationCommand}"
                         InputGesture="F1"/>
            </MenuItem>

            <!-- Temporary theme toggle (will move to Settings) -->
            <MenuItem Header="ðŸŽ¨ Theme"
                     HorizontalAlignment="Right"
                     Margin="0,0,20,0">
                <MenuItem Header="{Binding ThemeManager.ThemeButtonText, StringFormat='Switch to {0} Theme'}"
                         Command="{Binding ToggleThemeCommand}"
                         InputGesture="Ctrl+T"/>
            </MenuItem>

        </Menu>

        <!-- Main Content -->
        <Grid Grid.Row="1">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="{Binding IsSidebarExpanded, Converter={StaticResource BoolToSidebarWidthConverter}}"/>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>

            <!-- Files Panel -->
            <Grid Grid.Column="0" Background="{DynamicResource SecondaryBackground}" IsVisible="{Binding IsSidebarExpanded}">
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>

                <!-- Header with action buttons -->
                <Grid Grid.Row="0" Margin="8,8,8,8">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>
                        <ColumnDefinition Width="Auto"/>
                        <ColumnDefinition Width="Auto"/>
                    </Grid.ColumnDefinitions>

                    <TextBlock Grid.Column="0" Text="Loaded Files" FontWeight="SemiBold"
                              FontSize="14"
                              Foreground="{DynamicResource PrimaryText}"/>

                    <Button Grid.Column="1" Content="Deselect"
                            Padding="8,4"
                            FontSize="11"
                            Margin="0,0,4,0"
                            ToolTip.Tip="Clear file selection"
                            Click="OnClearSelectionClick"
                            IsVisible="{Binding SelectedFile, Converter={x:Static ObjectConverters.IsNotNull}}"/>

                    <Button Grid.Column="2" Content="Unload"
                            Classes="DangerButton"
                            Padding="8,4"
                            FontSize="11"
                            ToolTip.Tip="Remove selected file from list"
                            Click="OnUnloadFileClick"
                            IsVisible="{Binding SelectedFile, Converter={x:Static ObjectConverters.IsNotNull}}"/>
                </Grid>

                <ListBox Grid.Row="1"
                         ItemsSource="{Binding LoadedFiles}"
                         SelectedItem="{Binding SelectedFile}"
                         Margin="4"
                         Padding="0,0,0,-8"
                         Background="{DynamicResource CardBackground}"
                         BorderBrush="{DynamicResource BorderColor}"
                         BorderThickness="1"
                         CornerRadius="4">
                    <ListBox.ItemTemplate>
                        <DataTemplate>
                            <StackPanel Orientation="Vertical" Margin="0">
                                <Grid Tapped="OnFileItemTapped" Background="Transparent">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="Auto"/>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>

                                    <!-- Status icon -->
                                    <Panel Grid.Column="0" Margin="0,0,8,0" VerticalAlignment="Center">
                                        <TextBlock Text="â¬¢" FontSize="16" Foreground="{DynamicResource ErrorColor}" IsVisible="{Binding HasErrors}"/>
                                        <TextBlock Text="â–³" FontSize="16" Foreground="{DynamicResource AccentOrange}">
                                            <TextBlock.IsVisible>
                                                <MultiBinding Converter="{x:Static BoolConverters.And}">
                                                    <Binding Path="HasWarnings"/>
                                                    <Binding Path="HasErrors" Converter="{x:Static BoolConverters.Not}"/>
                                                </MultiBinding>
                                            </TextBlock.IsVisible>
                                        </TextBlock>
                                        <TextBlock Text="â—‹" FontSize="16" Foreground="{DynamicResource SuccessColor}">
                                            <TextBlock.IsVisible>
                                                <MultiBinding Converter="{x:Static BoolConverters.And}">
                                                    <Binding Path="HasErrors" Converter="{x:Static BoolConverters.Not}"/>
                                                    <Binding Path="HasWarnings" Converter="{x:Static BoolConverters.Not}"/>
                                                </MultiBinding>
                                            </TextBlock.IsVisible>
                                        </TextBlock>
                                    </Panel>

                                    <!-- File name and path -->
                                    <StackPanel Grid.Column="1" Orientation="Vertical">
                                        <TextBlock Text="{Binding FileName}"
                                                  FontWeight="Medium"
                                                  Foreground="{DynamicResource PrimaryText}"/>
                                        <TextBlock Text="{Binding FilePath}"
                                                  FontSize="10"
                                                  Foreground="{DynamicResource SecondaryText}"
                                                  TextTrimming="CharacterEllipsis"/>
                                    </StackPanel>

                                    <!-- Error count badge -->
                                    <Border Grid.Column="2"
                                           Background="{DynamicResource ErrorBackground}"
                                           CornerRadius="10"
                                           Padding="6,2"
                                           Margin="4,0,4,0"
                                           VerticalAlignment="Center">
                                        <Border.IsVisible>
                                            <MultiBinding Converter="{x:Static BoolConverters.Or}">
                                                <Binding Path="HasErrors"/>
                                                <Binding Path="HasWarnings"/>
                                            </MultiBinding>
                                        </Border.IsVisible>
                                        <TextBlock Text="{Binding Errors.Count, StringFormat='{}{0}'}"
                                                  FontSize="10"
                                                  FontWeight="SemiBold"
                                                  Foreground="{DynamicResource ErrorColor}"/>
                                    </Border>
                                </Grid>
                            </StackPanel>
                        </DataTemplate>
                    </ListBox.ItemTemplate>
                </ListBox>
            </Grid>

            <!-- Toggle Sidebar Bar (only visible when files are loaded) -->
            <Button Grid.Column="1"
                    Command="{Binding ToggleSidebarCommand}"
                    Background="{DynamicResource BorderColor}"
                    BorderThickness="0"
                    Padding="0"
                    CornerRadius="0"
                    HorizontalAlignment="Stretch"
                    VerticalAlignment="Stretch"
                    HorizontalContentAlignment="Center"
                    VerticalContentAlignment="Center"
                    Cursor="Hand"
                    Width="20"
                    IsVisible="{Binding HasLoadedFiles}"
                    ToolTip.Tip="{Binding IsSidebarExpanded, Converter={StaticResource BoolToTextConverter}, ConverterParameter='Collapse Sidebar|Expand Sidebar'}">
                <Button.Styles>
                    <Style Selector="Button:pointerover">
                        <Setter Property="Background" Value="{DynamicResource AccentOrange}"/>
                    </Style>
                    <Style Selector="Button:pressed">
                        <Setter Property="Background" Value="{DynamicResource PrimaryNavyBlue}"/>
                    </Style>
                </Button.Styles>
                <TextBlock Text="{Binding IsSidebarExpanded, Converter={StaticResource BoolToTextConverter}, ConverterParameter='â—€|â–¶'}"
                          FontSize="12"
                          Foreground="{DynamicResource SecondaryText}"
                          VerticalAlignment="Center"
                          HorizontalAlignment="Center"/>
            </Button>

            <!-- Main Content Area -->
            <Grid Grid.Column="2" Margin="12,0,0,0">
                <!-- Welcome Message (when no tabs visible) -->
                <Border IsVisible="{Binding HasAnyTabVisible, Converter={x:Static BoolConverters.Not}}"
                        HorizontalAlignment="Center"
                        VerticalAlignment="Center">
                    <StackPanel Spacing="16" HorizontalAlignment="Center">
                        <TextBlock Text="SheetAtlas"
                                  FontSize="24"
                                  FontWeight="SemiBold"
                                  Foreground="{DynamicResource PrimaryText}"
                                  HorizontalAlignment="Center"/>
                        <TextBlock Text="Start here: File â†’ Load Files"
                                  FontSize="14"
                                  Foreground="{DynamicResource SecondaryText}"
                                  HorizontalAlignment="Center"/>
                    </StackPanel>
                </Border>

                <!-- Content Area: Tab Control (full height) -->
                <TabControl SelectedIndex="{Binding SelectedTabIndex}"
                           IsVisible="{Binding HasAnyTabVisible}">
                    <!-- File Details Tab -->
                    <TabItem IsVisible="{Binding IsFileDetailsTabVisible}">
                        <TabItem.Header>
                            <StackPanel Orientation="Horizontal" Spacing="8">
                                <TextBlock Text="File Details" VerticalAlignment="Center"/>
                                <Button Content="âœ•"
                                        Command="{Binding CloseFileDetailsTabCommand}"
                                        Padding="4,0"
                                        FontSize="14"
                                        Background="Transparent"
                                        BorderThickness="0"
                                        Foreground="{DynamicResource SecondaryText}"
                                        ToolTip.Tip="Close tab"/>
                            </StackPanel>
                        </TabItem.Header>
                        <ContentControl Content="{Binding FileDetailsViewModel}">
                            <ContentControl.ContentTemplate>
                                <DataTemplate>
                                    <views:FileDetailsView/>
                                </DataTemplate>
                            </ContentControl.ContentTemplate>
                        </ContentControl>
                    </TabItem>

                    <!-- Search Tab -->
                    <TabItem IsVisible="{Binding IsSearchTabVisible}">
                        <TabItem.Header>
                            <StackPanel Orientation="Horizontal" Spacing="8">
                                <TextBlock Text="Search" VerticalAlignment="Center"/>
                                <Button Content="âœ•"
                                        Command="{Binding CloseSearchTabCommand}"
                                        Padding="4,0"
                                        FontSize="14"
                                        Background="Transparent"
                                        BorderThickness="0"
                                        Foreground="{DynamicResource SecondaryText}"
                                        ToolTip.Tip="Close tab"/>
                            </StackPanel>
                        </TabItem.Header>

                        <!-- Search Tab Content -->
                        <Grid Margin="8">
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="*"/>
                            </Grid.RowDefinitions>

                            <!-- Search Box -->
                            <Grid Grid.Row="0" Margin="0,0,0,8">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>

                                <TextBox Grid.Column="0"
                                         Text="{Binding SearchViewModel.SearchQuery}"
                                         Watermark="Enter search term..."
                                         Margin="0,0,8,0"
                                         KeyDown="OnSearchTextBoxKeyDown"/>

                                <Button Grid.Column="1" Content="Search"
                                        Command="{Binding SearchViewModel.SearchCommand}"
                                        Margin="0,0,4,0" Padding="12,6"/>

                                <Button Grid.Column="2" Content="Clear"
                                        Command="{Binding SearchViewModel.ClearSearchCommand}"
                                        Padding="12,6"/>
                            </Grid>

                            <!-- Search Options and Row Comparison Controls -->
                            <Grid Grid.Row="1" Margin="0,0,0,8">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>

                                <!-- Search Options -->
                                <StackPanel Grid.Column="0" Orientation="Horizontal">
                                    <CheckBox Content="Case Sensitive"
                                              IsChecked="{Binding SearchViewModel.CaseSensitive}"
                                              Margin="0,0,12,0"/>
                                    <CheckBox Content="Exact Match"
                                              IsChecked="{Binding SearchViewModel.ExactMatch}"
                                              Margin="0,0,12,0"/>
                                    <CheckBox Content="Use Regex"
                                              IsChecked="{Binding SearchViewModel.UseRegexSearch}"/>
                                </StackPanel>

                                <!-- Row Comparison Controls (aligned to the right) -->
                                <StackPanel Grid.Column="1" Orientation="Horizontal" HorizontalAlignment="Right" Spacing="8">
                                    <!-- Selected rows counter -->
                                    <Border Background="{DynamicResource InfoBackground}"
                                           CornerRadius="4"
                                           Padding="8,4"
                                           IsVisible="{Binding TreeSearchResultsViewModel.CanCompareRows}">
                                        <StackPanel Orientation="Horizontal" Spacing="4">
                                            <TextBlock Text="{Binding TreeSearchResultsViewModel.SelectedCount}"
                                                      FontWeight="SemiBold"
                                                      Foreground="{DynamicResource InfoColor}"/>
                                            <TextBlock Text="selected rows"
                                                      Foreground="{DynamicResource SecondaryText}"/>
                                        </StackPanel>
                                    </Border>

                                    <!-- Compare Rows Button -->
                                    <Button Content="Compare Rows"
                                            Classes="CTAButton"
                                            Command="{Binding TreeSearchResultsViewModel.CompareSelectedRowsCommand}"
                                            IsEnabled="{Binding TreeSearchResultsViewModel.CanCompareRows}"/>

                                    <!-- Clear Selection Button -->
                                    <Button Content="Clear"
                                            Classes="ModernButton"
                                            FontSize="12"
                                            Command="{Binding TreeSearchResultsViewModel.ClearSelectionCommand}"/>

                                    <!-- Clear History Button -->
                                    <Button Content="Clear History"
                                            Classes="ModernButton"
                                            FontSize="12"
                                            Command="{Binding TreeSearchResultsViewModel.ClearHistoryCommand}"/>
                                </StackPanel>
                            </Grid>

                            <!-- Search Results Tree View -->
                            <ContentControl Grid.Row="2" Content="{Binding TreeSearchResultsViewModel}">
                                <ContentControl.ContentTemplate>
                                    <DataTemplate>
                                        <views:TreeSearchResultsView/>
                                    </DataTemplate>
                                </ContentControl.ContentTemplate>
                            </ContentControl>
                        </Grid>
                    </TabItem>

                    <!-- Row Comparison Tab -->
                    <TabItem IsVisible="{Binding IsComparisonTabVisible}">
                        <TabItem.Header>
                            <StackPanel Orientation="Horizontal" Spacing="8">
                                <TextBlock Text="Row Comparison" VerticalAlignment="Center"/>
                                <Button Content="âœ•"
                                        Command="{Binding CloseComparisonTabCommand}"
                                        Padding="4,0"
                                        FontSize="14"
                                        Background="Transparent"
                                        BorderThickness="0"
                                        Foreground="{DynamicResource SecondaryText}"
                                        ToolTip.Tip="Close tab"/>
                            </StackPanel>
                        </TabItem.Header>

                        <Grid>
                            <!-- Comparison Stack (when comparisons exist) -->
                            <ScrollViewer VerticalScrollBarVisibility="Auto"
                                         IsVisible="{Binding RowComparisons.Count}">
                                <ItemsControl ItemsSource="{Binding RowComparisons}">
                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate x:DataType="vm:RowComparisonViewModel">
                                            <controls:CollapsibleSection IsExpanded="{Binding IsExpanded, Mode=TwoWay}"
                                                                         Margin="0,0,0,8">
                                                <controls:CollapsibleSection.Header>
                                                    <Grid ColumnDefinitions="*,Auto,Auto">
                                                        <!-- Title and Info -->
                                                        <StackPanel Grid.Column="0" Orientation="Vertical" VerticalAlignment="Center">
                                                            <TextBlock Text="{Binding Title}"
                                                                      FontWeight="SemiBold"
                                                                      FontSize="14"
                                                                      Foreground="{DynamicResource SearchQueryText}"/>
                                                            <StackPanel Orientation="Horizontal" Margin="0,4,0,0">
                                                                <TextBlock Text="{Binding RowCount}"
                                                                          FontWeight="SemiBold"
                                                                          FontSize="12"
                                                                          Foreground="{DynamicResource SearchQueryText}"/>
                                                                <TextBlock Text=" rows"
                                                                          FontSize="12"
                                                                          Foreground="{DynamicResource SearchQueryText}"
                                                                          Opacity="0.8"
                                                                          Margin="0,0,16,0"/>
                                                                <TextBlock Text="{Binding CreatedAt, StringFormat='HH:mm:ss'}"
                                                                          FontSize="12"
                                                                          Foreground="{DynamicResource SearchQueryText}"
                                                                          Opacity="0.8"/>
                                                            </StackPanel>
                                                        </StackPanel>

                                                        <!-- Close Button -->
                                                        <Button Grid.Column="2"
                                                                Content="âœ•"
                                                                Command="{Binding CloseCommand}"
                                                                Background="Transparent"
                                                                Foreground="{DynamicResource SearchQueryText}"
                                                                BorderThickness="0"
                                                                FontSize="14"
                                                                FontWeight="Bold"
                                                                Padding="8,4"
                                                                VerticalAlignment="Center"
                                                                ToolTip.Tip="Close comparison"/>
                                                    </Grid>
                                                </controls:CollapsibleSection.Header>
                                                <controls:CollapsibleSection.Content>
                                                    <views:RowComparisonView/>
                                                </controls:CollapsibleSection.Content>
                                            </controls:CollapsibleSection>
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                </ItemsControl>
                            </ScrollViewer>

                            <!-- Empty State (when no comparisons) -->
                            <Border HorizontalAlignment="Center"
                                   VerticalAlignment="Center"
                                   IsVisible="{Binding !RowComparisons.Count}">
                                <StackPanel Spacing="16" HorizontalAlignment="Center">
                                    <TextBlock Text="ðŸ“Š" FontSize="48" HorizontalAlignment="Center" Opacity="0.4"/>
                                    <TextBlock Text="No comparisons yet"
                                              FontSize="16"
                                              FontWeight="SemiBold"
                                              Foreground="{DynamicResource PrimaryText}"
                                              HorizontalAlignment="Center"/>
                                    <TextBlock Text="Select rows from search results to compare"
                                              FontSize="14"
                                              Foreground="{DynamicResource SecondaryText}"
                                              HorizontalAlignment="Center"/>
                                </StackPanel>
                            </Border>
                        </Grid>
                    </TabItem>

                </TabControl>
            </Grid>
        </Grid>

        <!-- Status Bar -->
        <Border Grid.Row="2"
                Background="{DynamicResource SecondaryBackground}"
                BorderBrush="{DynamicResource BorderColor}"
                BorderThickness="0,1,0,0"
                Padding="12,6"
                Margin="0,8,0,0"
                IsVisible="{Binding IsStatusBarVisible}">
            <Grid>
                <Grid.ColumnDefinitions>
                    <ColumnDefinition Width="*"/>
                    <ColumnDefinition Width="Auto"/>
                </Grid.ColumnDefinitions>

                <TextBlock Grid.Column="0"
                          Text="{Binding LoadedFiles.Count, StringFormat='{}{0} files loaded'}"
                          Foreground="{DynamicResource SecondaryText}"
                          FontSize="12"
                          VerticalAlignment="Center"/>

                <TextBlock Grid.Column="1"
                          Text="Ready"
                          Foreground="{DynamicResource SecondaryText}"
                          FontSize="12"
                          VerticalAlignment="Center"/>
            </Grid>
        </Border>
    </Grid>
</Window>
